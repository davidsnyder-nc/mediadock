<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaDock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Force refresh timestamp: 1749633850 -->
    <script>
        // Force cache clearing
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .bg-gray-900-gradient {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        }
        .nav-button {
            transition: all 0.2s ease-in-out;
            color: #9ca3af;
        }
        .nav-button.active {
            color: #e0f2fe !important; /* Light blue for active icon */
            background: rgba(59, 130, 246, 0.2) !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2) !important;
        }
        .nav-button.active i {
            color: #3b82f6 !important;
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.8)) !important;
        }
        .nav-button i {
            transition: all 0.3s ease;
        }
        .page { display: none; }
        .page.active { display: flex; flex-direction: column; height: 100%; }
        
        /* Force blue navigation overrides - highest priority */
        .desktop-nav-item.active,
        .nav-button.active,
        button.active {
            background: rgba(59, 130, 246, 0.2) !important;
            color: #3b82f6 !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2) !important;
        }
        
        /* Override any remaining green highlights */
        * {
            --tw-ring-color: rgba(59, 130, 246, 0.5) !important;
        }
        
        /* Specific targeting for navigation elements */
        .nav-button.active,
        .desktop-nav-item.active,
        nav button.active,
        [data-page].active {
            background-color: rgba(59, 130, 246, 0.2) !important;
            border-color: rgba(59, 130, 246, 0.3) !important;
            color: #3b82f6 !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2) !important;
        }
        
        /* Target all green Tailwind classes specifically */
        .bg-emerald-500, .bg-green-500, .bg-green-600, .bg-green-700,
        .text-emerald-500, .text-green-500, .text-green-400, .text-green-600,
        .border-emerald-500, .border-green-500, .border-green-600,
        .ring-emerald-500, .ring-green-500, .ring-green-600,
        .hover\:bg-green-700:hover, .hover\:bg-green-600:hover {
            background-color: rgba(59, 130, 246, 0.8) !important;
            color: #ffffff !important;
            border-color: rgba(59, 130, 246, 0.8) !important;
        }
        
        /* Navigation active states override */
        nav .nav-button.active,
        .desktop-nav .desktop-nav-item.active {
            background: rgba(59, 130, 246, 0.2) !important;
            color: #3b82f6 !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2) !important;
        }
        
        /* Card Flip Styles */
        .card-container {
            perspective: 1000px;
            aspect-ratio: 2 / 3.5; /* Give container a responsive aspect ratio */
        }
        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            background-color: transparent;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            overflow: hidden;
        }
        .card-face-front {
            z-index: 2;
        }
        .card-face-back {
            transform: rotateY(180deg);
        }
        .card-back-image {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(2px) brightness(0.3);
        }
        .card-back-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .card-image-container {
            background-size: cover;
            background-position: center;
            border-radius: 6px;
        }
        .action-btn {
            background: rgba(59, 130, 246, 0.8);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            background: rgba(59, 130, 246, 1);
            transform: translateY(-1px);
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .spinner {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s ease-in-out infinite;
            -moz-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @-moz-keyframes spin {
            to { -moz-transform: rotate(360deg); }
        }

        /* Desktop Layout Styles */
        @media (min-width: 768px) {
            .desktop-layout {
                display: flex;
                height: 100vh;
                max-width: none;
                margin: 0;
                padding: 0;
            }
            
            .desktop-sidebar {
                width: 280px;
                background: rgba(31, 41, 55, 0.95);
                backdrop-filter: blur(20px);
                border-right: 1px solid rgba(75, 85, 99, 0.3);
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                padding: 24px;
            }
            
            .desktop-nav {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .desktop-nav h2 {
                color: #ffffff;
                font-size: 1.5rem;
                font-weight: 700;
                margin-bottom: 32px;
                text-align: center;
                padding-bottom: 16px;
                border-bottom: 1px solid rgba(75, 85, 99, 0.3);
            }
            
            .desktop-nav-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                background: rgba(55, 65, 81, 0.5);
                color: #e5e7eb;
            }
            
            .desktop-nav-item.active {
                background: rgba(59, 130, 246, 0.2) !important;
                color: #3b82f6 !important;
                border: 1px solid rgba(59, 130, 246, 0.3) !important;
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.2) !important;
            }
            
            .desktop-info {
                background: rgba(31, 41, 55, 0.4);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(75, 85, 99, 0.3);
                border-radius: 12px;
                padding: 16px;
                margin-top: auto;
                text-align: center;
            }
            
            .desktop-content {
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            
            .desktop-content .flex-1 {
                flex: 1;
                overflow-y: auto;
            }
            
            /* Hide mobile navigation on desktop only */
            .desktop-layout nav {
                display: none !important;
            }
            
            /* Responsive media grids for desktop */
            .media-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 16px;
            }
            
            /* Recommendation type buttons */
            .rec-type-btn {
                background-color: #374151;
                color: #9ca3af;
            }
            .rec-type-btn.active {
                background-color: #3b82f6 !important;
                color: #ffffff !important;
            }
            .rec-type-btn:hover {
                background-color: #4b5563;
            }
            .rec-type-btn.active:hover {
                background-color: #2563eb !important;
            }
            

            
            /* Adjust main content grid for desktop */
            @media (min-width: 768px) {
                .main-content-grid {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 16px;
                }
            }
        }
        </style>
</head>
<body class="bg-gray-900-gradient text-white h-full">
    <script>
        // Configuration for GitHub version with placeholder keys
        const config = {
            sonarrUrl: 'http://your-sonarr-url:8989',
            sonarrApi: 'your-sonarr-api-key',
            radarrUrl: 'http://your-radarr-url:7878', 
            radarrApi: 'your-radarr-api-key',
            sabnzbdUrl: 'http://your-sabnzbd-url:8080',
            sabnzbdApi: 'your-sabnzbd-api-key',
            tmdbApi: 'your-tmdb-api-key',
            geminiApi: 'your-gemini-api-key',
            geminiEnabled: true,
            defaultPage: 'tv-page',
            defaultTvTab: 'calendar'
        };
    </script>

    <div id="app" class="max-w-md mx-auto h-full flex flex-col relative pb-20 md:pb-0 desktop-layout">
        <!-- Mobile Header (shown only on mobile) -->
        <header class="bg-gray-900/95 backdrop-blur-sm p-4 border-b border-gray-700/50 md:hidden">
            <h1 class="text-white text-xl font-semibold text-center" style="display: flex; align-items: center; justify-content: center;">
                <svg class="inline-block w-6 h-6 mr-2" viewBox="0 0 24 24" fill="currentColor" style="color: #3b82f6 !important;">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                MediaDock
            </h1>
        </header>
        
        <main class="flex-grow p-4 overflow-y-auto no-scrollbar desktop-content">
            <!-- Pages Container -->
            <div class="flex-1 overflow-auto">
                <!-- Movies Page -->
                <div id="movies-page" class="page">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">Movies</h2>
                            <div class="flex space-x-2">
                                <button onclick="toggleMovieView('recent')" id="movie-recent-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium">Recent</button>
                                <button onclick="toggleMovieView('search')" id="movie-search-btn" class="px-4 py-2 rounded-lg bg-gray-600 text-white font-medium">Search</button>
                            </div>
                        </div>

                        <!-- Movie Recent Tab -->
                        <div id="movie-recent" class="movie-tab">
                            <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50">
                                <h3 class="text-lg font-semibold text-white mb-4">Recently Added</h3>
                                <div id="radarr-recent" class="media-grid">
                                    <div class="flex justify-center py-8 col-span-full">
                                        <div class="spinner border-4 border-gray-300 rounded-full w-8 h-8"></div>
                                    </div>
                                </div>
                                <div class="flex justify-center mt-6">
                                    <button id="load-more-movies" class="hidden bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg transition-colors">
                                        Load More Movies
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Movie Search Tab -->
                        <div id="movie-search" class="movie-tab hidden">
                            <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50">
                                <div class="mb-6">
                                    <div class="relative">
                                        <input 
                                            id="movie-search-input" 
                                            type="text" 
                                            placeholder="Search for movies..."
                                            class="w-full bg-gray-800 text-white rounded-lg px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        >
                                        <button 
                                            id="movie-search-btn" 
                                            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-500 transition-colors"
                                        >
                                            <i data-lucide="search" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="movie-results" class="media-grid">
                                    <!-- Default content when no search results -->
                                    <div id="movie-default-content" class="col-span-full text-center py-12 space-y-6 flex flex-col items-center justify-center min-h-[400px]">
                                        <div class="mx-auto w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="text-xl font-semibold text-white mb-2">Search for Movies</h3>
                                            <p class="text-gray-400">Enter a movie title to search and add to your library</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TV Shows Page -->
                <div id="tv-page" class="page active">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">TV Shows</h2>
                            <div class="flex space-x-2">
                                <button onclick="toggleTvView('calendar')" id="tv-calendar-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium">Calendar</button>
                                <button onclick="toggleTvView('recent')" id="tv-recent-btn" class="px-4 py-2 rounded-lg bg-gray-600 text-white font-medium">Recent</button>
                                <button onclick="toggleTvView('search')" id="tv-search-btn" class="px-4 py-2 rounded-lg bg-gray-600 text-white font-medium">Search</button>
                            </div>
                        </div>

                        <!-- TV Calendar Tab -->
                        <div id="tv-calendar" class="tv-tab">
                            <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-white">Upcoming Episodes</h3>
                                    <span class="text-sm text-gray-400" id="tv-count">Loading...</span>
                                </div>
                                <div id="sonarr-calendar" class="space-y-3">
                                    <div class="flex justify-center py-8">
                                        <div class="spinner border-4 border-gray-300 rounded-full w-8 h-8"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TV Recent Tab -->
                        <div id="tv-recent" class="tv-tab hidden">
                            <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50">
                                <h3 class="text-lg font-semibold text-white mb-4">Recently Added</h3>
                                <div id="sonarr-recent" class="media-grid">
                                    <div class="flex justify-center py-8 col-span-full">
                                        <div class="spinner border-4 border-gray-300 rounded-full w-8 h-8"></div>
                                    </div>
                                </div>
                                <div class="flex justify-center mt-6">
                                    <button id="load-more-tv" class="hidden bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg transition-colors">
                                        Load More TV Shows
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- TV Search Tab -->
                        <div id="tv-search" class="tv-tab hidden">
                            <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50">
                                <div class="mb-6">
                                    <div class="relative">
                                        <input 
                                            id="tv-search-input" 
                                            type="text" 
                                            placeholder="Search for TV shows..."
                                            class="w-full bg-gray-800 text-white rounded-lg px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        >
                                        <button 
                                            id="tv-search-btn-action" 
                                            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-500 transition-colors"
                                        >
                                            <i data-lucide="search" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="tv-results" class="media-grid">
                                    <!-- Default content when no search results -->
                                    <div id="tv-default-content" class="col-span-full text-center py-12 space-y-6 flex flex-col items-center justify-center min-h-[400px]">
                                        <div class="mx-auto w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 12H3V5h18v10z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="text-xl font-semibold text-white mb-2">Search for TV Shows</h3>
                                            <p class="text-gray-400">Enter a show title to search and add to your library</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommended Page -->
                <div id="recommended-page" class="page">
                    <div class="p-6">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-white mb-4">AI Recommendations</h2>
                            
                            <!-- Recommendation Type Toggle -->
                            <div class="flex space-x-2 mb-6">
                                <button onclick="switchRecommendationType('movies')" id="rec-movies-btn" class="rec-type-btn px-4 py-2 rounded-lg font-medium transition-colors active">Movies</button>
                                <button onclick="switchRecommendationType('tv')" id="rec-tv-btn" class="rec-type-btn px-4 py-2 rounded-lg font-medium transition-colors">TV Shows</button>
                            </div>
                            
                            <!-- Mood Search -->
                            <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50 mb-6">
                                <h3 class="text-lg font-semibold text-white mb-4">Mood-Based Search</h3>
                                <div class="flex space-x-2">
                                    <div class="relative flex-1">
                                        <input 
                                            id="mood-search" 
                                            type="text" 
                                            placeholder="Describe what you're in the mood for..."
                                            class="w-full bg-gray-800 text-white rounded-lg px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        >
                                        <button 
                                            id="mood-search-btn" 
                                            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-500 transition-colors"
                                        >
                                            <i data-lucide="search" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                    <button 
                                        id="start-recommendations" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition-colors flex items-center space-x-2"
                                    >
                                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                                        <span>Get AI Recommendations</span>
                                    </button>
                                </div>
                                <p class="text-gray-400 text-sm mt-2">Try: "funny romantic comedies", "dark psychological thrillers", "feel-good family movies"</p>
                            </div>
                        </div>

                        <!-- Recommendation Results Section -->
                        <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50">
                            <div id="recommendations-status" class="text-center py-8">
                                <div class="mx-auto w-16 h-16 bg-gradient-to-br from-purple-500 to-blue-600 rounded-full flex items-center justify-center mb-4">
                                    <i data-lucide="sparkles" class="w-8 h-8 text-white"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-white mb-2">AI-Powered Recommendations</h3>
                                <p class="text-gray-400 mb-4">Get personalized movie and TV show recommendations based on your library and mood</p>
                                <button 
                                    id="start-recommendations-switch" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors"
                                >
                                    <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>
                                    Start Recommendations
                                </button>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div id="recommendations-loading" class="hidden text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                            <p class="text-gray-400 mt-2">Analyzing your library and generating recommendations...</p>
                        </div>

                        <!-- Results Container -->
                        <div id="recommendations-results" class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Downloads Page -->
                <div id="downloads-page" class="page">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">Downloads</h2>
                            <button onclick="loadSabnzbdHistory()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>Refresh
                            </button>
                        </div>
                        
                        <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50">
                            <h3 class="text-lg font-semibold text-white mb-4">SABnzbd History</h3>
                            <div id="sabnzbd-history" class="space-y-3">
                                <div class="flex justify-center py-8">
                                    <div class="spinner border-4 border-gray-300 rounded-full w-8 h-8"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings-page" class="page">
                    <div class="p-6 space-y-6">
                        <h2 class="text-2xl font-bold text-white">Settings</h2>
                        
                        <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50 space-y-4">
                            <h3 class="text-lg font-semibold text-white">API Configuration</h3>
                            
                            <div>
                                <label class="block text-white text-sm font-medium mb-1">Sonarr URL</label>
                                <input id="sonarr-url" type="text" placeholder="http://localhost:8989" class="w-full form-input text-white rounded-lg p-2">
                                <p class="text-gray-400 text-xs mt-1">Your Sonarr server URL</p>
                            </div>
                            
                            <div>
                                <label class="block text-white text-sm font-medium mb-1">Sonarr API Key</label>
                                <input id="sonarr-api" type="text" placeholder="Your Sonarr API key" class="w-full form-input text-white rounded-lg p-2">
                                <p class="text-gray-400 text-xs mt-1">Found in Sonarr Settings → General → Security → API Key</p>
                            </div>
                            
                            <div>
                                <label class="block text-white text-sm font-medium mb-1">Radarr URL</label>
                                <input id="radarr-url" type="text" placeholder="http://localhost:7878" class="w-full form-input text-white rounded-lg p-2">
                                <p class="text-gray-400 text-xs mt-1">Your Radarr server URL</p>
                            </div>
                            
                            <div>
                                <label class="block text-white text-sm font-medium mb-1">Radarr API Key</label>
                                <input id="radarr-api" type="text" placeholder="Your Radarr API key" class="w-full form-input text-white rounded-lg p-2">
                                <p class="text-gray-400 text-xs mt-1">Found in Radarr Settings → General → Security → API Key</p>
                            </div>
                            
                            <div>
                                <label class="block text-white text-sm font-medium mb-1">SABnzbd URL</label>
                                <input id="sabnzbd-url" type="text" placeholder="http://localhost:8080" class="w-full form-input text-white rounded-lg p-2">
                                <p class="text-gray-400 text-xs mt-1">Your SABnzbd server URL</p>
                            </div>
                            
                            <div>
                                <label class="block text-white text-sm font-medium mb-1">SABnzbd API Key</label>
                                <input id="sabnzbd-api" type="text" placeholder="Your SABnzbd API key" class="w-full form-input text-white rounded-lg p-2">
                                <p class="text-gray-400 text-xs mt-1">Found in SABnzbd Config → General → SABnzbd Web Server → API Key</p>
                            </div>
                            
                            <div>
                                <label class="block text-white text-sm font-medium mb-1">TMDB API Key</label>
                                <input id="tmdb-api" type="text" placeholder="Your TMDB API key" class="w-full form-input text-white rounded-lg p-2">
                                <p class="text-gray-400 text-xs mt-1">Get your API key from themoviedb.org</p>
                            </div>
                            
                            <div>
                                <label class="block text-white text-sm font-medium mb-1">Gemini AI API Key</label>
                                <input id="gemini-api" type="text" placeholder="Your Gemini API key" class="w-full form-input text-white rounded-lg p-2">
                                <p class="text-gray-400 text-xs mt-1">Get your API key from Google AI Studio (ai.google.dev)</p>
                            </div>
                            
                            <div class="flex items-center space-x-3 p-3 bg-gray-800 rounded-lg">
                                <input id="gemini-enabled" type="checkbox" class="form-checkbox h-4 w-4 text-blue-500 rounded">
                                <div>
                                    <label for="gemini-enabled" class="text-white text-sm font-medium">Enable Gemini AI Descriptions</label>
                                    <p class="text-gray-400 text-xs">Generates witty, personalized descriptions for movies and TV shows</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50 space-y-4">
                            <h3 class="text-lg font-semibold text-white">App Preferences</h3>
                            
                            <div>
                                <label class="block text-white text-sm font-medium mb-2">Default Page</label>
                                <select id="default-page" class="w-full bg-gray-700 text-white rounded-lg p-2">
                                    <option value="movies-page">Movies</option>
                                    <option value="tv-page">TV Shows</option>
                                    <option value="recommended-page">Recommended</option>
                                    <option value="downloads-page">Downloads</option>
                                </select>
                                <p class="text-gray-400 text-xs mt-1">Page to show when the app loads</p>
                            </div>
                            
                            <div>
                                <label class="block text-white text-sm font-medium mb-2">Default TV Tab</label>
                                <select id="default-tv-tab" class="w-full bg-gray-700 text-white rounded-lg p-2">
                                    <option value="calendar">Calendar</option>
                                    <option value="recent">Recent</option>
                                    <option value="search">Search</option>
                                </select>
                                <p class="text-gray-400 text-xs mt-1">Tab to show when TV Shows page loads</p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors">
                                <i data-lucide="save" class="w-4 h-4 inline mr-1"></i>Save Settings
                            </button>
                            <button onclick="resetSettings()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition-colors">
                                <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>Reset to Defaults
                            </button>
                        </div>
                        
                        <div class="bg-gray-800/30 rounded-lg p-6 border border-gray-700/50">
                            <h3 class="text-lg font-semibold text-white mb-2">Statistics</h3>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="bg-gray-700/30 rounded-lg p-4">
                                    <div class="text-2xl font-bold text-blue-400" id="movies-count">--</div>
                                    <div class="text-sm text-gray-400">Movies</div>
                                </div>
                                <div class="bg-gray-700/30 rounded-lg p-4">
                                    <div class="text-2xl font-bold text-blue-400" id="series-count">--</div>
                                    <div class="text-sm text-gray-400">TV Series</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Desktop Sidebar (hidden on mobile) -->
        <div class="desktop-sidebar hidden md:flex">
            <div class="desktop-nav">
                <h2 style="display: flex; align-items: center; justify-content: center;">
                    <svg class="inline-block w-6 h-6 mr-2" viewBox="0 0 24 24" fill="currentColor" style="color: #3b82f6;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    MediaDock
                </h2>
                <div class="desktop-nav-item" data-page="movies-page">
                    <i data-lucide="film"></i>
                    <span>Movies</span>
                </div>
                <div class="desktop-nav-item active" data-page="tv-page">
                    <i data-lucide="tv"></i>
                    <span>TV Shows</span>
                </div>
                <div class="desktop-nav-item" data-page="recommended-page">
                    <i data-lucide="sparkles"></i>
                    <span>Recommended</span>
                </div>
                <div class="desktop-nav-item" data-page="downloads-page">
                    <i data-lucide="arrow-down-to-line"></i>
                    <span>Downloads</span>
                </div>
                <div class="desktop-nav-item" data-page="settings-page">
                    <i data-lucide="settings"></i>
                    <span>Settings</span>
                </div>
            </div>
            
            <div class="desktop-info">
                <h3 class="text-white font-semibold mb-2">MediaDock</h3>
                <p class="text-gray-400 text-xs">AI-powered media management</p>
            </div>
        </div>

        <!-- Navigation Bar -->
        <nav class="flex justify-around bg-gray-800/50 backdrop-filter backdrop-blur-lg p-2 fixed bottom-0 left-0 right-0 border-t border-gray-700/50 z-10 md:hidden">
            <button data-page="movies-page" class="nav-button relative flex-1 flex flex-col items-center p-2 rounded-lg">
                <i data-lucide="film"></i><span class="text-xs mt-1">Movies</span>
            </button>
            <button data-page="tv-page" class="nav-button relative flex-1 flex flex-col items-center p-2 rounded-lg">
                <i data-lucide="tv"></i><span class="text-xs mt-1">TV</span>
            </button>
            <button data-page="recommended-page" class="nav-button relative flex-1 flex flex-col items-center p-2 rounded-lg">
                <i data-lucide="sparkles"></i><span class="text-xs mt-1">Recommended</span>
            </button>
            <button data-page="downloads-page" class="nav-button relative flex-1 flex flex-col items-center p-2 rounded-lg">
                <i data-lucide="arrow-down-to-line"></i><span class="text-xs mt-1">Downloads</span>
            </button>
            <button data-page="settings-page" class="nav-button relative flex-1 flex flex-col items-center p-2 rounded-lg">
                <i data-lucide="settings"></i><span class="text-xs mt-1">Settings</span>
            </button>
        </nav>
        
    </div>

    <script>
        // Global variables
        let userSettings = config;
        let currentPage = userSettings.defaultPage || 'tv-page';
        let currentMoviePage = 1;
        let currentTvPage = 1;
        let hasMoreMovies = true;
        let hasMoreTv = true;

        // DOM elements
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-button');

        // Utility Functions
        const makeApiRequest = async (url) => {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        };

        const showNotification = (message, type = 'info') => {
            const notificationModal = document.createElement('div');
            notificationModal.className = `fixed bottom-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg text-white shadow-lg ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-blue-600' : 'bg-blue-600'}`;
            notificationModal.textContent = message;
            notificationModal.style.zIndex = '9999';
            document.body.appendChild(notificationModal);
            
            setTimeout(() => {
                notificationModal.remove();
            }, 3000);
        };

        // Card flip functionality
        const flipCard = (cardContainer, id) => {
            const card = cardContainer.querySelector('.card');
            card.classList.toggle('is-flipped');
        };

        // YouTube trailer search
        const watchTrailer = async (movieId, type = 'movie') => {
            try {
                const response = await makeApiRequest(`https://api.themoviedb.org/3/${type}/${movieId}/videos?api_key=${userSettings.tmdbApi}`);
                const trailer = response.results.find(video => 
                    video.type === 'Trailer' && video.site === 'YouTube'
                ) || response.results[0];
                
                if (trailer) {
                    window.open(`https://www.youtube.com/watch?v=${trailer.key}`, '_blank');
                } else {
                    showNotification('No trailer found', 'error');
                }
            } catch (error) {
                console.error('Error fetching trailer:', error);
                showNotification('Error loading trailer', 'error');
            }
        };

        const watchTvTrailerBySeries = async (seriesTitle, year = '') => {
            try {
                const searchQuery = year ? `${seriesTitle} ${year}` : seriesTitle;
                const response = await makeApiRequest(`https://api.themoviedb.org/3/search/tv?api_key=${userSettings.tmdbApi}&query=${encodeURIComponent(searchQuery)}`);
                
                if (response.results && response.results.length > 0) {
                    const series = response.results[0];
                    await watchTrailer(series.id, 'tv');
                } else {
                    showNotification('TV show not found on TMDB', 'error');
                }
            } catch (error) {
                console.error('Error searching for TV show:', error);
                showNotification('Error searching for trailer', 'error');
            }
        };

        // --- Navigation ---
        const showPage = (pageId) => {
            const wasAlreadyOnTvPage = currentPage === 'tv-page' && pageId === 'tv-page';
            
            pages.forEach(page => page.classList.remove('active'));
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                // Clear inline styles from inactive buttons
                btn.style.background = '';
                btn.style.color = '';
                btn.style.border = '';
                btn.style.boxShadow = '';
            });
            document.querySelectorAll('.desktop-nav-item').forEach(item => {
                item.classList.remove('active');
                // Clear inline styles from inactive items
                item.style.background = '';
                item.style.color = '';
                item.style.border = '';
                item.style.boxShadow = '';
            });
            
            document.getElementById(pageId).classList.add('active');
            const mobileBtn = document.querySelector(`nav [data-page="${pageId}"]`);
            const desktopItem = document.querySelector(`.desktop-nav-item[data-page="${pageId}"]`);
            
            if (mobileBtn) {
                mobileBtn.classList.add('active');
                // Force blue navigation styling
                mobileBtn.style.background = 'rgba(59, 130, 246, 0.2)';
                mobileBtn.style.color = '#3b82f6';
                mobileBtn.style.border = '1px solid rgba(59, 130, 246, 0.3)';
                mobileBtn.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.2)';
            }
            if (desktopItem) {
                desktopItem.classList.add('active');
                // Force blue navigation styling
                desktopItem.style.background = 'rgba(59, 130, 246, 0.2)';
                desktopItem.style.color = '#3b82f6';
                desktopItem.style.border = '1px solid rgba(59, 130, 246, 0.3)';
                desktopItem.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.2)';
            }
            
            currentPage = pageId;

            if (pageId === 'tv-page') {
                if (wasAlreadyOnTvPage) {
                    // If already on TV page, switch to search
                    toggleTvView('search');
                } else {
                    // First time loading TV page, use the default tab from settings
                    toggleTvView(userSettings.defaultTvTab || 'calendar');
                }
            } else if (pageId === 'movies-page') {
                // Load recent movies by default when movies page is shown
                toggleMovieView('recent');
            } else if (pageId === 'downloads-page') {
                loadSabnzbdHistory();
            } else if (pageId === 'settings-page') {
                loadSettings();
                loadCounts();
            }
        };

        // Load Sonarr calendar data
        const loadSonarrCalendar = async () => {
            try {
                const today = new Date();
                const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                
                const [calendarResponse, seriesResponse] = await Promise.all([
                    makeApiRequest(`${userSettings.sonarrUrl}/api/v3/calendar?start=${today.toISOString().split('T')[0]}&end=${nextWeek.toISOString().split('T')[0]}&apikey=${userSettings.sonarrApi}`),
                    makeApiRequest(`${userSettings.sonarrUrl}/api/v3/series?apikey=${userSettings.sonarrApi}`)
                ]);
                
                const calendar = calendarResponse;
                const allSeries = seriesResponse;
                
                // Create series lookup map
                const seriesMap = {};
                allSeries.forEach(series => {
                    seriesMap[series.id] = {
                        title: series.title,
                        poster: series.images?.find(img => img.coverType === 'poster')?.remoteUrl
                    };
                });
                
                // Group episodes by day
                const episodesByDay = {};
                calendar.forEach(episode => {
                    const date = new Date(episode.airDateUtc).toDateString();
                    if (!episodesByDay[date]) {
                        episodesByDay[date] = [];
                    }
                    episodesByDay[date].push(episode);
                });
                
                // Generate calendar HTML
                let calendarHtml = '';
                const sortedDates = Object.keys(episodesByDay).sort((a, b) => new Date(a) - new Date(b));
                
                sortedDates.forEach((dateStr, index) => {
                    const date = new Date(dateStr);
                    const isToday = date.toDateString() === today.toDateString();
                    const isTomorrow = date.toDateString() === new Date(today.getTime() + 24 * 60 * 60 * 1000).toDateString();
                    const isYesterday = date.toDateString() === new Date(today.getTime() - 24 * 60 * 60 * 1000).toDateString();
                    
                    let dayLabel;
                    if (isToday) dayLabel = 'Today';
                    else if (isTomorrow) dayLabel = 'Tomorrow';
                    else if (isYesterday) dayLabel = 'Yesterday';
                    else dayLabel = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                    
                    calendarHtml += `
                        <div class="mb-6">
                            <h4 class="text-white font-semibold text-base mb-3 pb-2 border-b border-gray-700">${dayLabel}</h4>
                            <div class="space-y-2">
                    `;
                    
                    episodesByDay[dateStr].forEach(episode => {
                        const seriesInfo = seriesMap[episode.seriesId] || { title: 'Unknown Series', poster: null };
                        const airTime = new Date(episode.airDateUtc).toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit',
                            hour12: true 
                        });
                        
                        calendarHtml += `
                            <div class="flex items-center space-x-3 p-3 bg-gray-700/30 rounded-lg hover:bg-gray-700/50 transition-colors">
                                <div class="w-12 h-16 bg-gray-600 rounded flex-shrink-0 overflow-hidden">
                                    ${seriesInfo.poster ? 
                                        `<img src="${seriesInfo.poster}" alt="${seriesInfo.title}" class="w-full h-full object-cover">` : 
                                        `<div class="w-full h-full flex items-center justify-center text-gray-400 text-xs">No Image</div>`
                                    }
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h5 class="text-white font-medium truncate">${seriesInfo.title}</h5>
                                    <p class="text-gray-300 text-sm">Season ${episode.seasonNumber}, Episode ${episode.episodeNumber}</p>
                                    <p class="text-gray-400 text-sm truncate">${episode.title || 'Episode ' + episode.episodeNumber}</p>
                                </div>
                                <div class="text-right flex-shrink-0">
                                    <p class="text-blue-400 text-sm font-medium">${airTime}</p>
                                    <p class="text-gray-400 text-xs">
                                        ${episode.hasFile ? 
                                            '<span class="text-blue-400">Downloaded</span>' : 
                                            '<span class="text-yellow-400">Not Downloaded</span>'
                                        }
                                    </p>
                                </div>
                            </div>
                        `;
                    });
                    
                    calendarHtml += `
                            </div>
                        </div>
                    `;
                });
                
                if (calendarHtml === '') {
                    calendarHtml = `
                        <div class="text-center py-12">
                            <div class="mx-auto w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="calendar" class="w-8 h-8 text-white"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-white mb-2">No upcoming episodes</h3>
                            <p class="text-gray-400">All caught up! Check back later for new episodes.</p>
                        </div>
                    `;
                }
                
                document.getElementById('sonarr-calendar').innerHTML = calendarHtml;
                document.getElementById('tv-count').textContent = `${calendar.length} episodes`;
                
                // Re-initialize Lucide icons
                lucide.createIcons();
                
            } catch (error) {
                console.error('Sonarr calendar unavailable:', error);
                document.getElementById('sonarr-calendar').innerHTML = `
                    <div class="text-center py-8">
                        <div class="mx-auto w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="wifi-off" class="w-8 h-8 text-white"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-white mb-2">Unable to connect to Sonarr</h3>
                        <p class="text-gray-400">Please check your Sonarr configuration in Settings</p>
                    </div>
                `;
                lucide.createIcons();
            }
        };

        // Load Sonarr recent series with files
        const loadSonarrRecent = async (page = 1) => {
            try {
                const [seriesResponse, episodeFilesResponse] = await Promise.all([
                    makeApiRequest(`${userSettings.sonarrUrl}/api/v3/series?apikey=${userSettings.sonarrApi}`),
                    makeApiRequest(`${userSettings.sonarrUrl}/api/v3/episodefile?apikey=${userSettings.sonarrApi}`)
                ]);
                
                const allSeries = seriesResponse;
                const allEpisodeFiles = episodeFilesResponse;
                
                // Group episode files by series ID and find the latest download date for each series
                const seriesWithFiles = {};
                allEpisodeFiles.forEach(file => {
                    if (!seriesWithFiles[file.seriesId]) {
                        seriesWithFiles[file.seriesId] = {
                            episodes: [],
                            latestDate: new Date(file.dateAdded)
                        };
                    }
                    seriesWithFiles[file.seriesId].episodes.push(file);
                    const fileDate = new Date(file.dateAdded);
                    if (fileDate > seriesWithFiles[file.seriesId].latestDate) {
                        seriesWithFiles[file.seriesId].latestDate = fileDate;
                    }
                });
                
                // Filter to only series with recent downloads (within last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const seriesWithRecentFiles = allSeries
                    .filter(series => {
                        const seriesFiles = seriesWithFiles[series.id];
                        return seriesFiles && seriesFiles.latestDate > thirtyDaysAgo;
                    })
                    .map(series => {
                        const seriesFiles = seriesWithFiles[series.id];
                        return {
                            series: series,
                            latestDownloadDate: seriesFiles.latestDate,
                            recentEpisodeCount: seriesFiles.episodes.length,
                            totalEpisodeCount: series.statistics?.totalEpisodeCount || 0
                        };
                    });
                
                // Sort by latest download date
                const sortedSeries = seriesWithRecentFiles
                    .sort((a, b) => new Date(b.latestDownloadDate) - new Date(a.latestDownloadDate));
                
                    console.log(`Found ${sortedSeries.length} unique series with recent downloads`);
                    
                    // Calculate pagination - show 20 items per page for better user experience
                    const itemsPerPage = 20;
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedSeries = sortedSeries.slice(startIndex, endIndex);
                    const hasMoreSeries = endIndex < sortedSeries.length;
                    
                    console.log(`Page ${page}: showing ${paginatedSeries.length} series (${startIndex}-${endIndex} of ${sortedSeries.length})`);
                    console.log(`Has more series: ${hasMoreSeries}`);

                    // Pre-fetch Gemini descriptions if enabled
                    const tvDescriptions = {};
                    if (userSettings.geminiEnabled) {
                        await Promise.all(paginatedSeries.map(async (item) => {
                            try {
                                const wittyDesc = await getWittyTvDescription(item.series.title, item.series.id, item.series.overview);
                                if (wittyDesc) {
                                    tvDescriptions[item.series.id] = wittyDesc;
                                }
                            } catch (error) {
                                console.log('Failed to pre-fetch description for', item.series.title);
                            }
                        }));
                    }

                    const seriesHtml = paginatedSeries.map(item => {
                        const series = item.series;
                        const posterUrl = series.images?.find(img => img.coverType === 'poster')?.remoteUrl || 'https://via.placeholder.com/300x450?text=No+Image';
                        const year = series.year || 'Unknown';
                        
                        // Show recent episodes count and when it was last updated
                        const recentText = item.recentEpisodeCount === 1 ? 
                            '1 new episode' : 
                            `${item.recentEpisodeCount} new episodes`;
                        const daysSinceDownload = Math.floor((new Date() - item.latestDownloadDate) / (1000 * 60 * 60 * 24));
                        const timeText = daysSinceDownload === 0 ? 'today' : 
                                       daysSinceDownload === 1 ? 'yesterday' : 
                                       `${daysSinceDownload} days ago`;
                        
                        const description = tvDescriptions[series.id] || series.overview || 'No description available';
                    
                        return `
                            <div class="card-container w-full" onclick="flipCard(this, ${series.id})">
                                <div class="card">
                                    <div class="card-face card-face-front">
                                        <div class="bg-black/70 backdrop-blur-sm rounded p-2 mb-2">
                                            <div class="flex items-center justify-between">
                                                <h3 class="text-white font-semibold text-sm truncate">${series.title}</h3>
                                                <span class="text-gray-300 text-xs ml-2 flex-shrink-0">${year}</span>
                                            </div>
                                            <p class="text-gray-400 text-xs">${timeText}</p>
                                        </div>
                                        <div class="card-image-container flex-1" style="background-image: url('${posterUrl}')">
                                        </div>
                                    </div>
                                    <div class="card-face card-face-back">
                                        <div class="card-back-image" style="background-image: url('${posterUrl}');"></div>
                                        <div class="card-back-overlay">
                                            <div class="text-center space-y-4">
                                                <h3 class="text-white font-bold text-lg">${series.title}</h3>
                                                <div class="flex items-center justify-center space-x-2">
                                                    <span class="text-yellow-400 text-sm">★</span>
                                                    <span class="text-white text-sm">${series.ratings?.value ? series.ratings.value.toFixed(1) : 'N/A'}</span>
                                                </div>
                                                <p class="text-gray-200 text-sm" id="tv-desc-${series.id}">${description}</p>
                                                <div class="flex flex-col space-y-2 w-full">
                                                    <button onclick="event.stopPropagation(); watchTvTrailerBySeries('${series.title}', '${series.year || ''}')" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                        <i data-lucide="play" class="w-4 h-4 inline mr-1"></i>Watch Trailer
                                                    </button>
                                                    <div class="text-center text-xs text-gray-300">
                                                        <span>${item.totalEpisodeCount} total episodes</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                
                if (page === 1) {
                    document.getElementById('sonarr-recent').innerHTML = seriesHtml;
                } else {
                    document.getElementById('sonarr-recent').innerHTML += seriesHtml;
                }
                
                // Show/hide Load More button
                const loadMoreBtn = document.getElementById('load-more-tv');
                if (hasMoreSeries) {
                    loadMoreBtn.classList.remove('hidden');
                    loadMoreBtn.onclick = () => loadSonarrRecent(page + 1);
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
                
                // Re-initialize Lucide icons
                lucide.createIcons();
                
                if (seriesHtml === '') {
                    document.getElementById('sonarr-recent').innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="mx-auto w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="tv" class="w-8 h-8 text-white"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-white mb-2">No recent downloads</h3>
                            <p class="text-gray-400">No TV shows have been downloaded recently</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
                
            } catch (error) {
                console.error('Error loading Sonarr recent:', error);
                document.getElementById('sonarr-recent').innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="mx-auto w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="wifi-off" class="w-8 h-8 text-white"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-white mb-2">Unable to connect to Sonarr</h3>
                        <p class="text-gray-400">Please check your Sonarr configuration in Settings</p>
                    </div>
                `;
                lucide.createIcons();
            }
        };

        // Load Radarr recent movies
        const loadRadarrRecent = async (page = 1) => {
            try {
                const response = await makeApiRequest(`${userSettings.radarrUrl}/api/v3/movie?apikey=${userSettings.radarrApi}`);
                const movies = response.filter(movie => movie.hasFile);
                
                // Sort by date added (most recent first)
                const sortedMovies = movies.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
                
                // Calculate pagination
                const itemsPerPage = 20;
                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedMovies = sortedMovies.slice(startIndex, endIndex);
                const hasMoreMovies = endIndex < sortedMovies.length;
                
                // Pre-fetch Gemini descriptions if enabled
                const movieDescriptions = {};
                if (userSettings.geminiEnabled) {
                    await Promise.all(paginatedMovies.map(async (movie) => {
                        try {
                            const wittyDesc = await getWittyMovieDescription(movie.title, movie.id, movie.overview);
                            if (wittyDesc) {
                                movieDescriptions[movie.id] = wittyDesc;
                            }
                        } catch (error) {
                            console.log('Failed to pre-fetch description for', movie.title);
                        }
                    }));
                }

                const moviesHtml = paginatedMovies.map(movie => {
                    const posterUrl = movie.images?.find(img => img.coverType === 'poster')?.remoteUrl || 'https://via.placeholder.com/300x450?text=No+Image';
                    const year = movie.year || 'Unknown';
                    const status = movie.hasFile ? 'Downloaded' : 'Missing';
                    const statusColor = movie.hasFile ? 'text-green-400' : 'text-yellow-400';
                    const description = movieDescriptions[movie.id] || movie.overview || 'No description available';
                    
                    return `
                        <div class="card-container w-full" onclick="flipCard(this, ${movie.id})">
                            <div class="card">
                                <div class="card-face card-face-front">
                                    <div class="bg-black/70 backdrop-blur-sm rounded p-2 mb-2">
                                        <div class="flex items-center justify-between">
                                            <h3 class="text-white font-semibold text-sm truncate">${movie.title}</h3>
                                            <span class="text-gray-300 text-xs ml-2 flex-shrink-0">${year}</span>
                                        </div>

                                    </div>
                                    <div class="card-image-container flex-1" style="background-image: url('${posterUrl}')">
                                    </div>
                                </div>
                                <div class="card-face card-face-back">
                                    <div class="card-back-image" style="background-image: url('${posterUrl}');"></div>
                                    <div class="card-back-overlay">
                                        <div class="text-center space-y-4">
                                            <h3 class="text-white font-bold text-lg">${movie.title}</h3>
                                            <div class="flex items-center justify-center space-x-2">
                                                <span class="text-yellow-400 text-sm">★</span>
                                                <span class="text-white text-sm">${movie.ratings?.imdb?.value ? movie.ratings.imdb.value.toFixed(1) : movie.ratings?.tmdb?.value ? movie.ratings.tmdb.value.toFixed(1) : 'N/A'}</span>
                                            </div>
                                            <p class="text-gray-200 text-sm" id="movie-desc-${movie.id}">${description}</p>
                                            <div class="flex flex-col space-y-2 w-full">
                                                <button onclick="event.stopPropagation(); watchTrailer(${movie.tmdbId})" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                    <i data-lucide="play" class="w-4 h-4 inline mr-1"></i>Watch Trailer
                                                </button>
                                                <button onclick="event.stopPropagation(); window.open('https://www.themoviedb.org/movie/${movie.tmdbId}', '_blank')" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                    <i data-lucide="external-link" class="w-4 h-4 inline mr-1"></i>View on TMDB
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (page === 1) {
                    document.getElementById('radarr-recent').innerHTML = moviesHtml;
                } else {
                    document.getElementById('radarr-recent').innerHTML += moviesHtml;
                }
                
                // Show/hide Load More button
                const loadMoreBtn = document.getElementById('load-more-movies');
                if (hasMoreMovies) {
                    loadMoreBtn.classList.remove('hidden');
                    loadMoreBtn.onclick = () => loadRadarrRecent(page + 1);
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
                
                // Re-initialize Lucide icons
                lucide.createIcons();
                
                if (moviesHtml === '') {
                    document.getElementById('radarr-recent').innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="mx-auto w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="film" class="w-8 h-8 text-white"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-white mb-2">No movies found</h3>
                            <p class="text-gray-400">No downloaded movies in your library</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
                
            } catch (error) {
                console.error('Error loading Radarr recent:', error);
                document.getElementById('radarr-recent').innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="mx-auto w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="wifi-off" class="w-8 h-8 text-white"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-white mb-2">Unable to connect to Radarr</h3>
                        <p class="text-gray-400">Please check your Radarr configuration in Settings</p>
                    </div>
                `;
                lucide.createIcons();
            }
        };

        // Load SABnzbd download history
        const loadSabnzbdHistory = async () => {
            try {
                const response = await makeApiRequest(`${userSettings.sabnzbdUrl}/api?mode=history&limit=50&apikey=${userSettings.sabnzbdApi}&output=json`);
                const history = response.history?.slots || [];
                
                const historyHtml = history.map(item => {
                    const completedDate = new Date(item.completed * 1000).toLocaleDateString();
                    const size = (item.bytes / (1024 * 1024 * 1024)).toFixed(2);
                    
                    return `
                        <div class="flex items-center justify-between p-4 bg-gray-700/30 rounded-lg hover:bg-gray-700/50 transition-colors">
                            <div class="flex-1 min-w-0">
                                <h4 class="text-white font-medium truncate">${item.name}</h4>
                                <p class="text-gray-400 text-sm">${completedDate} • ${size} GB</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 rounded text-xs ${
                                    item.status === 'Completed' ? 'bg-blue-600' : 
                                    item.status === 'Failed' ? 'bg-red-600' : 'bg-yellow-600'
                                } text-white">
                                    ${item.status}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('sabnzbd-history').innerHTML = historyHtml || `
                    <div class="text-center py-8">
                        <div class="mx-auto w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="download" class="w-8 h-8 text-white"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-white mb-2">No downloads</h3>
                        <p class="text-gray-400">Your download history is empty</p>
                    </div>
                `;
                
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading SABnzbd history:', error);
                document.getElementById('sabnzbd-history').innerHTML = `
                    <div class="text-center py-8">
                        <div class="mx-auto w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="wifi-off" class="w-8 h-8 text-white"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-white mb-2">Unable to connect to SABnzbd</h3>
                        <p class="text-gray-400">Please check your SABnzbd configuration in Settings</p>
                    </div>
                `;
                lucide.createIcons();
            }
        };

        // Search movies function
        const searchMovies = async (query) => {
            if (!query) return;
            
            try {
                const response = await makeApiRequest(`https://api.themoviedb.org/3/search/movie?api_key=${userSettings.tmdbApi}&query=${encodeURIComponent(query)}`);
                const movies = response.results || [];
                
                const moviesHtml = movies.map(movie => {
                    const posterUrl = movie.poster_path ? 
                        `https://image.tmdb.org/t/p/w500${movie.poster_path}` : 
                        'https://via.placeholder.com/300x450?text=No+Image';
                    const year = movie.release_date ? new Date(movie.release_date).getFullYear() : 'Unknown';
                    
                    return `
                        <div class="card-container w-full" onclick="flipCard(this, ${movie.id})">
                            <div class="card">
                                <div class="card-face card-face-front">
                                    <div class="bg-black/70 backdrop-blur-sm rounded p-2 mb-2">
                                        <div class="flex items-center justify-between">
                                            <h3 class="text-white font-semibold text-sm truncate">${movie.title}</h3>
                                            <span class="text-gray-300 text-xs ml-2 flex-shrink-0">${year}</span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <span class="text-yellow-400 text-xs">★</span>
                                            <span class="text-white text-xs">${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="card-image-container flex-1" style="background-image: url('${posterUrl}')">
                                    </div>
                                </div>
                                <div class="card-face card-face-back">
                                    <div class="card-back-image" style="background-image: url('${posterUrl}');"></div>
                                    <div class="card-back-overlay">
                                        <div class="text-center space-y-4">
                                            <h3 class="text-white font-bold text-lg">${movie.title}</h3>
                                            <div class="flex items-center justify-center space-x-2">
                                                <span class="text-yellow-400 text-sm">★</span>
                                                <span class="text-white text-sm">${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</span>
                                            </div>
                                            <p class="text-gray-200 text-sm">${movie.overview || 'No description available'}</p>
                                            <div class="flex flex-col space-y-2 w-full">
                                                <button onclick="addToRadarr('${movie.id}'); event.stopPropagation()" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>Add to Radarr
                                                </button>
                                                <button onclick="watchTrailer('${movie.id}'); event.stopPropagation()" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                    <i data-lucide="play" class="w-4 h-4 inline mr-1"></i>Watch Trailer
                                                </button>
                                                <button onclick="window.open('https://www.themoviedb.org/movie/${movie.id}', '_blank'); event.stopPropagation()" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                    <i data-lucide="external-link" class="w-4 h-4 inline mr-1"></i>View on TMDB
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('movie-results').innerHTML = moviesHtml;
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error searching movies:', error);
                showNotification('Error searching movies', 'error');
            }
        };

        // Search TV shows function
        const searchTvShows = async (query) => {
            if (!query) return;
            
            try {
                const response = await makeApiRequest(`https://api.themoviedb.org/3/search/tv?api_key=${userSettings.tmdbApi}&query=${encodeURIComponent(query)}`);
                const shows = response.results || [];
                
                const showsHtml = shows.map(show => {
                    const posterUrl = show.poster_path ? 
                        `https://image.tmdb.org/t/p/w500${show.poster_path}` : 
                        'https://via.placeholder.com/300x450?text=No+Image';
                    const year = show.first_air_date ? new Date(show.first_air_date).getFullYear() : 'Unknown';
                    
                    return `
                        <div class="card-container w-full" onclick="flipCard(this, ${show.id})">
                            <div class="card">
                                <div class="card-face card-face-front">
                                    <div class="bg-black/70 backdrop-blur-sm rounded p-2 mb-2">
                                        <div class="flex items-center justify-between">
                                            <h3 class="text-white font-semibold text-sm truncate">${show.name}</h3>
                                            <span class="text-gray-300 text-xs ml-2 flex-shrink-0">${year}</span>
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <span class="text-yellow-400 text-xs">★</span>
                                            <span class="text-white text-xs">${show.vote_average ? show.vote_average.toFixed(1) : 'N/A'}</span>
                                        </div>
                                    </div>
                                    <div class="card-image-container flex-1" style="background-image: url('${posterUrl}')">
                                    </div>
                                </div>
                                <div class="card-face card-face-back">
                                    <div class="card-back-image" style="background-image: url('${posterUrl}');"></div>
                                    <div class="card-back-overlay">
                                        <div class="text-center space-y-4">
                                            <h3 class="text-white font-bold text-lg">${show.name}</h3>
                                            <div class="flex items-center justify-center space-x-2">
                                                <span class="text-yellow-400 text-sm">★</span>
                                                <span class="text-white text-sm">${show.vote_average ? show.vote_average.toFixed(1) : 'N/A'}</span>
                                            </div>
                                            <p class="text-gray-200 text-sm">${show.overview || 'No description available'}</p>
                                            <div class="flex flex-col space-y-2 w-full">
                                                <button onclick="addToSonarr('${show.id}'); event.stopPropagation()" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>Add to Sonarr
                                                </button>
                                                <button onclick="watchTrailer('${show.id}', 'tv'); event.stopPropagation()" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                    <i data-lucide="play" class="w-4 h-4 inline mr-1"></i>Watch Trailer
                                                </button>
                                                <button onclick="window.open('https://www.themoviedb.org/tv/${show.id}', '_blank'); event.stopPropagation()" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                    <i data-lucide="external-link" class="w-4 h-4 inline mr-1"></i>View on TMDB
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('tv-results').innerHTML = showsHtml;
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error searching TV shows:', error);
                showNotification('Error searching TV shows', 'error');
            }
        };

        // Add to Radarr function
        const addToRadarr = async (tmdbId) => {
            try {
                // First, get movie details from TMDB
                const movieDetails = await makeApiRequest(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${userSettings.tmdbApi}`);
                
                // Get root folders from Radarr
                const rootFolders = await makeApiRequest(`${userSettings.radarrUrl}/api/v3/rootfolder?apikey=${userSettings.radarrApi}`);
                const rootFolderPath = rootFolders[0]?.path || '/movies';
                
                // Get quality profiles
                const qualityProfiles = await makeApiRequest(`${userSettings.radarrUrl}/api/v3/qualityprofile?apikey=${userSettings.radarrApi}`);
                const qualityProfileId = qualityProfiles[0]?.id || 1;
                
                const movieData = {
                    title: movieDetails.title,
                    year: new Date(movieDetails.release_date).getFullYear(),
                    tmdbId: parseInt(tmdbId),
                    qualityProfileId: qualityProfileId,
                    rootFolderPath: rootFolderPath,
                    monitored: true,
                    addOptions: {
                        monitor: 'movieOnly',
                        searchForMovie: true
                    }
                };
                
                const response = await fetch(`${userSettings.radarrUrl}/api/v3/movie?apikey=${userSettings.radarrApi}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(movieData)
                });
                
                if (response.ok) {
                    showNotification(`${movieDetails.title} added to Radarr!`, 'success');
                } else {
                    throw new Error('Failed to add movie');
                }
                
            } catch (error) {
                console.error('Error adding to Radarr:', error);
                showNotification('Error adding movie to Radarr', 'error');
            }
        };

        // Add to Sonarr function
        const addToSonarr = async (tmdbId) => {
            try {
                // First, get TV show details from TMDB
                const showDetails = await makeApiRequest(`https://api.themoviedb.org/3/tv/${tmdbId}?api_key=${userSettings.tmdbApi}`);
                
                // Get root folders from Sonarr
                const rootFolders = await makeApiRequest(`${userSettings.sonarrUrl}/api/v3/rootfolder?apikey=${userSettings.sonarrApi}`);
                const rootFolderPath = rootFolders[0]?.path || '/tv';
                
                // Get quality profiles
                const qualityProfiles = await makeApiRequest(`${userSettings.sonarrUrl}/api/v3/qualityprofile?apikey=${userSettings.sonarrApi}`);
                const qualityProfileId = qualityProfiles[0]?.id || 1;
                
                // Get language profiles
                const languageProfiles = await makeApiRequest(`${userSettings.sonarrUrl}/api/v3/languageprofile?apikey=${userSettings.sonarrApi}`);
                const languageProfileId = languageProfiles[0]?.id || 1;
                
                const showData = {
                    title: showDetails.name,
                    year: new Date(showDetails.first_air_date).getFullYear(),
                    tvdbId: 0, // We'll use TMDB ID since we don't have TVDB ID
                    qualityProfileId: qualityProfileId,
                    languageProfileId: languageProfileId,
                    rootFolderPath: rootFolderPath,
                    monitored: true,
                    seasonFolder: true,
                    addOptions: {
                        monitor: 'all',
                        searchForMissingEpisodes: true,
                        searchForCutoffUnmetEpisodes: false
                    }
                };
                
                const response = await fetch(`${userSettings.sonarrUrl}/api/v3/series?apikey=${userSettings.sonarrApi}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(showData)
                });
                
                if (response.ok) {
                    showNotification(`${showDetails.name} added to Sonarr!`, 'success');
                } else {
                    throw new Error('Failed to add TV show');
                }
                
            } catch (error) {
                console.error('Error adding to Sonarr:', error);
                showNotification('Error adding TV show to Sonarr', 'error');
            }
        };

        // Toggle movie view
        const toggleMovieView = (view) => {
            // Update tab buttons
            document.querySelectorAll('.movie-tab').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('[id^="movie-"]').forEach(btn => {
                if (btn.id.includes('btn')) {
                    btn.classList.remove('bg-blue-600');
                    btn.classList.add('bg-gray-600');
                }
            });
            
            document.getElementById(`movie-${view}`).classList.remove('hidden');
            document.getElementById(`movie-${view}-btn`).classList.remove('bg-gray-600');
            document.getElementById(`movie-${view}-btn`).classList.add('bg-blue-600');
            
            if (view === 'recent') {
                currentMoviePage = 1;
                loadRadarrRecent(1);
            }
        };

        // Toggle TV view
        const toggleTvView = (view) => {
            document.querySelectorAll('.tv-tab').forEach(tab => tab.classList.add('hidden'));
            
            // Clear active states from all TV buttons
            const recentBtn = document.getElementById('tv-recent-btn');
            const calendarBtn = document.getElementById('tv-calendar-btn');
            const searchBtn = document.getElementById('tv-search-btn');
            
            recentBtn?.classList.remove('active');
            calendarBtn?.classList.remove('active');
            searchBtn?.classList.remove('active');
            
            // Reset all button styles
            [recentBtn, calendarBtn, searchBtn].forEach(btn => {
                if (btn) {
                    btn.classList.remove('bg-blue-600');
                    btn.classList.add('bg-gray-600');
                }
            });
            
            // Show selected tab and activate button
            document.getElementById(`tv-${view}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tv-${view}-btn`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-600');
                activeBtn.classList.add('bg-blue-600');
                activeBtn.classList.add('active');
            }
            
            // Load data for the selected view
            if (view === 'calendar') {
                loadSonarrCalendar();
            } else if (view === 'recent') {
                currentTvPage = 1;
                loadSonarrRecent(1);
            } else if (view === 'search') {
                // Reset search results to show default content
                const resultsContainer = document.getElementById('tv-results');
                const defaultContent = document.getElementById('tv-default-content');
                if (!defaultContent) {
                    // Re-create default content if it doesn't exist
                    resultsContainer.innerHTML = `
                        <div id="tv-default-content" class="col-span-full text-center py-12 space-y-6 flex flex-col items-center justify-center min-h-[400px]">
                            <div class="mx-auto w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 12H3V5h18v10z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-white mb-2">Search for TV Shows</h3>
                                <p class="text-gray-400">Enter a show title to search and add to your library</p>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }
        };

        // Settings functions
        const loadSettings = () => {
            // Load settings from embedded config
            document.getElementById('sonarr-url').value = userSettings.sonarrUrl || '';
            document.getElementById('sonarr-api').value = userSettings.sonarrApi || '';
            document.getElementById('radarr-url').value = userSettings.radarrUrl || '';
            document.getElementById('radarr-api').value = userSettings.radarrApi || '';
            document.getElementById('sabnzbd-url').value = userSettings.sabnzbdUrl || '';
            document.getElementById('sabnzbd-api').value = userSettings.sabnzbdApi || '';
            document.getElementById('tmdb-api').value = userSettings.tmdbApi || '';
            document.getElementById('gemini-api').value = userSettings.geminiApi || '';
            document.getElementById('gemini-enabled').checked = userSettings.geminiEnabled || false;
            document.getElementById('default-page').value = userSettings.defaultPage || 'tv-page';
            document.getElementById('default-tv-tab').value = userSettings.defaultTvTab || 'calendar';
        };

        const saveSettings = () => {
            const newSettings = {
                sonarrUrl: document.getElementById('sonarr-url').value,
                sonarrApi: document.getElementById('sonarr-api').value,
                radarrUrl: document.getElementById('radarr-url').value,
                radarrApi: document.getElementById('radarr-api').value,
                sabnzbdUrl: document.getElementById('sabnzbd-url').value,
                sabnzbdApi: document.getElementById('sabnzbd-api').value,
                tmdbApi: document.getElementById('tmdb-api').value,
                geminiApi: document.getElementById('gemini-api').value,
                geminiEnabled: document.getElementById('gemini-enabled').checked,
                defaultPage: document.getElementById('default-page').value,
                defaultTvTab: document.getElementById('default-tv-tab').value
            };
            
            // Update userSettings object
            Object.assign(userSettings, newSettings);
            
            showNotification('Settings saved successfully!', 'success');
        };

        const resetSettings = () => {
            // Reset to default config values
            userSettings = { ...config };
            loadSettings();
            showNotification('Settings reset to defaults', 'info');
        };

        const loadCounts = async () => {
            try {
                // Load movie count
                try {
                    const movies = await makeApiRequest(`${userSettings.radarrUrl}/api/v3/movie?apikey=${userSettings.radarrApi}`);
                    const downloadedMovies = movies.filter(movie => movie.hasFile);
                    document.getElementById('movies-count').textContent = downloadedMovies.length;
                } catch (error) {
                    console.error('Error loading Radarr movie count:', error);
                    document.getElementById('movies-count').textContent = '--';
                }
                
                // Load series count
                try {
                    const series = await makeApiRequest(`${userSettings.sonarrUrl}/api/v3/series?apikey=${userSettings.sonarrApi}`);
                    document.getElementById('series-count').textContent = series.length;
                } catch (error) {
                    console.error('Error loading Sonarr series count:', error);
                    document.getElementById('series-count').textContent = '--';
                }
            } catch (error) {
                console.error('Error loading counts:', error);
            }
        };

        // Gemini AI Integration
        const generateGeminiResponse = async (prompt) => {
            if (!userSettings.geminiEnabled || !userSettings.geminiApi) {
                throw new Error('Gemini AI is not enabled or API key is missing');
            }
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${userSettings.geminiApi}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Gemini API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.candidates[0]?.content?.parts[0]?.text || '';
            } catch (error) {
                console.error('Gemini API error:', error);
                throw error;
            }
        };

        const getWittyMovieDescription = async (title, movieId, originalDescription) => {
            if (!userSettings.geminiEnabled) return originalDescription;
            
            try {
                const prompt = `Write a funny, witty, and slightly sarcastic but affectionate 2-sentence description for the movie "${title}". Make it entertaining and capture the essence of the movie in a humorous way. Don't be mean, just playfully cheeky. Keep it under 100 words.`;
                
                const response = await generateGeminiResponse(prompt);
                return response || originalDescription;
            } catch (error) {
                console.log('Failed to generate witty description for', title);
                return originalDescription;
            }
        };

        const getWittyTvDescription = async (title, seriesId, originalDescription) => {
            if (!userSettings.geminiEnabled) return originalDescription;
            
            try {
                const prompt = `Write a funny, witty, and slightly sarcastic but affectionate 2-sentence description for the TV show "${title}". Make it entertaining and capture the essence of the show in a humorous way. Don't be mean, just playfully cheeky. Keep it under 100 words.`;
                
                const response = await generateGeminiResponse(prompt);
                return response || originalDescription;
            } catch (error) {
                console.log('Failed to generate witty description for', title);
                return originalDescription;
            }
        };

        // Recommendations functionality
        let currentRecommendationType = 'movies';

        const switchRecommendationType = (type) => {
            currentRecommendationType = type;
            const moviesBtn = document.getElementById('rec-movies-btn');
            const tvBtn = document.getElementById('rec-tv-btn');
            
            if (type === 'movies') {
                moviesBtn.classList.add('active');
                tvBtn.classList.remove('active');
            } else {
                tvBtn.classList.add('active');
                moviesBtn.classList.remove('active');
            }
        };

        const generateRecommendations = async (moodQuery = '') => {
            if (!userSettings.geminiEnabled || !userSettings.geminiApi) {
                showNotification('Please enable Gemini AI and add your API key in Settings', 'error');
                return;
            }
            
            try {
                // Show loading state
                document.getElementById('recommendations-status').classList.add('hidden');
                document.getElementById('recommendations-loading').classList.remove('hidden');
                
                let libraryData = '';
                let searchPrompt = '';
                
                if (currentRecommendationType === 'movies') {
                    // Get user's movie library
                    const movies = await makeApiRequest(`${userSettings.radarrUrl}/api/v3/movie?apikey=${userSettings.radarrApi}`);
                    const movieTitles = movies.slice(0, 50).map(m => m.title).join(', ');
                    libraryData = `Movies in library: ${movieTitles}`;
                    
                    if (moodQuery) {
                        searchPrompt = `Based on the user's movie library and their request: "${moodQuery}", recommend 12 movies that match their mood. Focus on movies they don't already have.`;
                    } else {
                        searchPrompt = `Based on the user's movie library, recommend 12 movies they might enjoy based on their current collection. Focus on similar genres and styles.`;
                    }
                } else {
                    // Get user's TV library
                    const series = await makeApiRequest(`${userSettings.sonarrUrl}/api/v3/series?apikey=${userSettings.sonarrApi}`);
                    const seriesTitles = series.slice(0, 50).map(s => s.title).join(', ');
                    libraryData = `TV shows in library: ${seriesTitles}`;
                    
                    if (moodQuery) {
                        searchPrompt = `Based on the user's TV show library and their request: "${moodQuery}", recommend 12 TV shows that match their mood. Focus on shows they don't already have.`;
                    } else {
                        searchPrompt = `Based on the user's TV show library, recommend 12 TV shows they might enjoy based on their current collection. Focus on similar genres and styles.`;
                    }
                }
                
                const fullPrompt = `${libraryData}\n\n${searchPrompt}\n\nReturn only a JSON array of objects with this exact structure: [{"title": "Movie/Show Title", "year": 2023, "reason": "Brief reason why recommended"}]. No other text.`;
                
                const response = await generateGeminiResponse(fullPrompt);
                console.log('Gemini response:', response);
                
                // Parse the JSON response
                let recommendations;
                try {
                    recommendations = JSON.parse(response);
                } catch (parseError) {
                    // Try to extract JSON from the response
                    const jsonMatch = response.match(/\[.*\]/s);
                    if (jsonMatch) {
                        recommendations = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('Could not parse recommendations');
                    }
                }
                
                if (!Array.isArray(recommendations)) {
                    throw new Error('Invalid recommendations format');
                }
                
                // Search for each recommendation on TMDB
                const recommendedItems = await Promise.all(
                    recommendations.map(async (rec) => {
                        try {
                            const searchType = currentRecommendationType === 'movies' ? 'movie' : 'tv';
                            const tmdbResponse = await makeApiRequest(
                                `https://api.themoviedb.org/3/search/${searchType}?api_key=${userSettings.tmdbApi}&query=${encodeURIComponent(rec.title)}`
                            );
                            
                            if (tmdbResponse.results && tmdbResponse.results.length > 0) {
                                const item = tmdbResponse.results[0];
                                return {
                                    ...item,
                                    recommendation_reason: rec.reason
                                };
                            }
                            return null;
                        } catch (error) {
                            console.error(`Error fetching TMDB data for ${rec.title}:`, error);
                            return null;
                        }
                    })
                );
                
                const validRecommendations = recommendedItems.filter(item => item !== null);
                displayRecommendations(validRecommendations);
                
            } catch (error) {
                console.error('Error generating recommendations:', error);
                showNotification('Error generating recommendations. Please try again.', 'error');
                document.getElementById('recommendations-loading').classList.add('hidden');
                document.getElementById('recommendations-status').classList.remove('hidden');
            }
        };

        const displayRecommendations = (recommendations) => {
            document.getElementById('recommendations-loading').classList.add('hidden');
            
            if (recommendations.length === 0) {
                document.getElementById('recommendations-results').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="mx-auto w-16 h-16 bg-yellow-600 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="search" class="w-8 h-8 text-white"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-white mb-2">No recommendations found</h3>
                        <p class="text-gray-400">Try a different search query or check your library</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            const recommendationsHtml = recommendations.map(item => {
                const isMovie = currentRecommendationType === 'movies';
                const title = isMovie ? item.title : item.name;
                const releaseDate = isMovie ? item.release_date : item.first_air_date;
                const year = releaseDate ? new Date(releaseDate).getFullYear() : 'Unknown';
                const posterUrl = item.poster_path ? 
                    `https://image.tmdb.org/t/p/w500${item.poster_path}` : 
                    'https://via.placeholder.com/300x450?text=No+Image';
                
                return `
                    <div class="card-container w-full" onclick="flipCard(this, ${item.id})">
                        <div class="card">
                            <div class="card-face card-face-front">
                                <div class="bg-black/70 backdrop-blur-sm rounded p-2 mb-2">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-white font-semibold text-sm truncate">${title}</h3>
                                        <span class="text-gray-300 text-xs ml-2 flex-shrink-0">${year}</span>
                                    </div>
                                    <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">Recommended</span>
                                </div>
                                <div class="card-image-container flex-1" style="background-image: url('${posterUrl}')">
                                </div>
                            </div>
                            <div class="card-face card-face-back">
                                <div class="card-back-image" style="background-image: url('${posterUrl}');"></div>
                                <div class="card-back-overlay">
                                    <div class="text-center space-y-4">
                                        <h3 class="text-white font-bold text-lg">${title}</h3>
                                        <div class="flex items-center justify-center space-x-2">
                                            <span class="text-yellow-400 text-sm">★</span>
                                            <span class="text-white text-sm">${item.vote_average ? item.vote_average.toFixed(1) : 'N/A'}</span>
                                        </div>
                                        <p class="text-blue-300 text-sm font-medium">${item.recommendation_reason}</p>
                                        <p class="text-gray-200 text-sm">${item.overview || 'No description available'}</p>
                                        <div class="flex flex-col space-y-2 w-full">
                                            <button onclick="${isMovie ? `addToRadarr('${item.id}')` : `addToSonarr('${item.id}')`}; event.stopPropagation()" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>Add to ${isMovie ? 'Radarr' : 'Sonarr'}
                                            </button>
                                            <button onclick="watchTrailer('${item.id}', '${isMovie ? 'movie' : 'tv'}'); event.stopPropagation()" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                <i data-lucide="play" class="w-4 h-4 inline mr-1"></i>Watch Trailer
                                            </button>
                                            <button onclick="window.open('https://www.themoviedb.org/${isMovie ? 'movie' : 'tv'}/${item.id}', '_blank'); event.stopPropagation()" class="action-btn text-white px-4 py-2 rounded-lg text-sm font-medium">
                                                <i data-lucide="external-link" class="w-4 h-4 inline mr-1"></i>View on TMDB
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('recommendations-results').innerHTML = recommendationsHtml;
            lucide.createIcons();
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Using embedded configuration:', userSettings);
            
            // Initialize navigation
            navButtons.forEach(button => {
                button.addEventListener('click', () => showPage(button.dataset.page));
            });
            
            document.querySelectorAll('.desktop-nav-item').forEach(item => {
                item.addEventListener('click', () => showPage(item.dataset.page));
            });
            
            // Search functionality
            document.getElementById('movie-search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        document.getElementById('movie-default-content').style.display = 'none';
                        searchMovies(query);
                    }
                }
            });
            
            document.getElementById('movie-search-btn').addEventListener('click', () => {
                const query = document.getElementById('movie-search-input').value.trim();
                if (query) {
                    document.getElementById('movie-default-content').style.display = 'none';
                    searchMovies(query);
                }
            });
            
            document.getElementById('tv-search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        document.getElementById('tv-default-content').style.display = 'none';
                        searchTvShows(query);
                    }
                }
            });
            
            document.getElementById('tv-search-btn-action').addEventListener('click', () => {
                const query = document.getElementById('tv-search-input').value.trim();
                if (query) {
                    document.getElementById('tv-default-content').style.display = 'none';
                    searchTvShows(query);
                }
            });
            
            // Recommendations functionality
            document.getElementById('start-recommendations').addEventListener('click', () => {
                generateRecommendations();
            });
            
            document.getElementById('start-recommendations-switch').addEventListener('click', () => {
                generateRecommendations();
            });
            
            document.getElementById('mood-search').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    generateRecommendations(query);
                }
            });
            
            document.getElementById('mood-search-btn').addEventListener('click', () => {
                const query = document.getElementById('mood-search').value.trim();
                generateRecommendations(query);
            });
            
            // Initialize icons
            lucide.createIcons();
            
            // Load initial page
            showPage(currentPage);
        });
    </script>
</body>
</html>